name: Release Verification

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created, published]

jobs:
  release-verification:
    name: Release Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc clang cmake build-essential

      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install gcc llvm cmake

      - name: Run ALL compiler checks (GCC + Clang)
        run: |
          chmod +x scripts/build/run_all_compilers.sh
          ./scripts/build/run_all_compilers.sh
          if ! grep -q "GCC:   PASS" compiler_check_results/summary.txt || \
             ! grep -q "Clang: PASS" compiler_check_results/summary.txt; then
            echo "❌ RELEASE BLOCKED: Compiler warnings found"
            exit 1
          fi
          echo "✅ Compiler checks: 25/25 files clean"

      - name: Run ALL unit tests
        run: |
          chmod +x scripts/test/run_unit_tests.sh
          ./scripts/test/run_unit_tests.sh
          echo "✅ Unit tests completed"

      - name: Run ALL comprehensive examples
        timeout-minutes: 20
        run: |
          chmod +x scripts/test/test_all_comprehensive.sh
          ./scripts/test/test_all_comprehensive.sh 2>&1 | tee release_test_output.log
          if ! grep -q "ALL TESTS PASSED" release_test_output.log; then
            echo "❌ RELEASE BLOCKED: Example tests failed"
            exit 1
          fi
          echo "✅ All 41 examples passed with sanitizers"

      - name: Create release archive
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p varint-$VERSION
          cp -r src/ varint-$VERSION/
          cp -r docs/ varint-$VERSION/
          cp -r examples/ varint-$VERSION/
          cp CMakeLists.txt README.md LICENSE varint-$VERSION/ 2>/dev/null || true
          tar -czf varint-$VERSION.tar.gz varint-$VERSION/
          echo "✅ Release archive created: varint-$VERSION.tar.gz"

      - name: Upload release artifacts
        if: startsWith(matrix.os, 'ubuntu')
        uses: actions/upload-artifact@v4
        with:
          name: release-archive
          path: varint-*.tar.gz
          retention-days: 90

  release-quality-gate:
    name: Release Quality Gate
    runs-on: ubuntu-latest
    needs: [release-verification]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Quality gate summary
        run: |
          echo "# Release Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ✅ All Release Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ GCC: 25/25 files clean (strict warnings)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Clang: 25/25 files clean (strict warnings)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Unit Tests: 8/8 passed with sanitizers" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Examples: 41/41 passed with ASan+UBSan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release is ready for deployment**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
